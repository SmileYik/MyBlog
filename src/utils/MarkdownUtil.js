import {marked} from "marked";
import hljs from "highlight.js";
import MathJax from "mathjax3-react";
import React from "react";
import "../common/style/night-owl.min.css"
import "../common/style/markdown-style.css"

export const MarkdownUtil = {
  defaultRenderer: new marked.Renderer(),
  codeCopyIcon: "<svg aria-hidden='true' height='16' viewBox='0 0 16 16' width='16' data-view-component='true' class='code-tool-line-item-icon'>\n" +
                "    <path fill='#bbb' fill-rule='evenodd' d='M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z'></path><path fill='#bbb' fill-rule='evenodd' d='M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z'></path>\n" +
                "</svg>",
  hideIcon: '<svg t="1722243309093" class="code-tool-line-item-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1586" width="16" height="16"><path fill="#bbb" d="M153.6 473.6h716.8v76.8H153.6v-76.8z" p-id="1587"></path></svg>',
  expandIcon: '<svg t="1751298821959" class="code-tool-line-item-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2162" width="16" height="16"><path d="M714.27370623 141.21142578h67.41385716c27.91277775 0 51.74690871 9.88762917 71.49250467 29.66288824C872.91577659 190.6396849 882.78363013 214.42932121 882.78363013 242.33221152V309.79550667c0 9.2696528-3.26291773 17.20447542-9.88762917 23.78963631-6.56044191 6.59010498-14.51504016 9.88762917-23.81435532 9.88762989-9.29931517 0-17.27368832-3.29752417-23.83413096-9.88762989-6.60493653-6.59010498-9.89751734-14.51998353-9.89751661-23.78963631V242.3371556c0-9.26470871-3.26291773-17.19458725-9.88762918-23.78469295-6.56538599-6.59010498-14.51504016-9.88762917-23.83907504-9.88762918H714.19954925c-9.29931517 0-17.24402596-3.29752417-23.82424278-9.88762915s-9.87774172-14.51998353-9.87774171-23.88851305c0-9.2696528 3.29752417-17.20447542 9.87774171-23.78963633 6.58021754-6.59010498 14.52492761-9.88762917 23.82918686-9.88762916h0.0692129zM444.60344607 141.21142578h134.80793941c9.31414671 0 17.23413778 3.29752417 23.8687374 9.98650588 6.55055444 6.49122901 9.87774172 14.52492761 9.87774171 23.78963633 0 9.2696528-3.32718727 17.20447542-9.87774171 23.78963632-6.63459962 6.59010498-14.55459069 9.88762917-23.8687374 9.88762916H444.60344607c-9.29931517 0-17.24402596-3.29752417-23.82424277-9.88762916-6.61482398-6.59010498-9.89751734-14.51998353-9.89751734-23.78963632 0-9.26470871 3.28269263-17.30335141 9.89751734-23.78469297C427.35942084 144.50894996 435.30413091 141.21142578 444.60344607 141.21142578z m404.47819957 269.60599063c9.29931517 0 17.25391343 3.39640089 23.81435532 9.88762917 6.62471144 6.59010498 9.88762917 14.51998353 9.88762917 23.88851303v134.80793942c0 9.26470871-3.26291773 17.19458725-9.88762917 23.78469223-6.56044191 6.59504907-14.51504016 9.88762917-23.81435532 9.88762916-9.29931517 0-17.27368832-3.29258081-23.83413096-9.88762916-6.60493653-6.59010498-9.89751734-14.51998353-9.89751661-23.78469223V444.59355861c0-9.36852878 3.29258081-17.29840732 9.89751661-23.88851303 6.56044191-6.49122901 14.53481506-9.88762917 23.82918687-9.88762918z m0 269.60599063c9.29931517 0 17.25391343 3.29752417 23.81435532 9.88762989 6.62471144 6.59010498 9.88762917 14.51998353 9.88762917 23.8934564v67.34958763c0 27.90783367-9.86785426 51.79634669-29.60356207 71.57160502-19.74559598 19.6664949-43.5797262 29.55412407-71.49250466 29.55412407h-67.41385717c-9.32403415 0-17.25391343-3.29258081-23.85390586-9.88762916-6.56538599-6.59010498-9.86785426-14.51998353-9.86785426-23.78469223 0-9.37347288 3.30246827-17.30335141 9.86785426-23.89345641 6.59999243-6.59010498 14.53481506-9.88762917 23.85390586-9.8876299h67.41385717c9.29931517 0 17.25391343-3.29258081 23.80446786-9.88762916 6.63459962-6.59010498 9.89751734-14.51998353 9.89751734-23.78469223V714.10067325c0-9.2696528 3.30741236-17.19953134 9.89751663-23.78963632 6.59504907-6.59010498 14.53481506-9.88762917 23.8440184-9.88762989h-0.04943799zM242.37670615 141.21142578H309.79550667c9.30920334 0 17.21930624 3.29752417 23.82918686 9.98650588 6.58516089 6.49122901 9.8826858 14.52492761 9.8826858 23.78963633 0 9.2696528-3.29752417 17.20447542-9.87774172 23.78963632-6.61482398 6.59010498-14.52492761 9.88762917-23.83413094 9.88762916H242.38164951c-9.31414671 0-17.27368832 3.29752417-23.83413023 9.88762918-6.61482398 6.59010498-9.90246071 14.51998353-9.9024607 23.88851303V309.79550667c0 9.37347288-3.28269263 17.20447542-9.89751736 23.8934564-6.56044191 6.48628492-14.52492761 9.88762917-23.82424277 9.88762989-9.30920334 0-17.25391343-3.40134426-23.8242435-9.88762989-6.6098799-6.69392507-9.88762917-14.51998353-9.88762917-23.8934564V242.44097568C141.21142578 214.42932121 151.07928004 190.64957307 170.83476348 170.97319c19.74559598-19.77525907 43.56983876-29.66288824 71.48756058-29.66288823l0.05932545-0.09887599z m202.22673992 674.01497657h134.80793941c9.31414671 0 17.23413778 3.29752417 23.86873739 9.8876299 6.55055444 6.59010498 9.87774172 14.51998353 9.87774172 23.89345641 0 9.26470871-3.32718727 17.19458725-9.87774172 23.78469223-6.63459962 6.59504907-14.55459069 9.88762917-23.86873739 9.88762916H444.60344607c-9.29931517 0-17.24402596-3.29258081-23.82424277-9.88762916-6.61482398-6.59010498-9.89751734-14.51998353-9.89751734-23.78469223 0-9.37347288 3.28269263-17.30335141 9.89751734-23.89345641 6.58021754-6.59010498 14.52492761-9.88762917 23.82424277-9.8876299z m-269.61587808-404.40404185c9.29931517 0 17.23908188 3.3914568 23.79952377 9.88268508 6.63459962 6.59010498 9.90246071 14.51998353 9.90246072 23.88851304v134.8079394c0 9.26470871-3.26291773 17.19458725-9.90246072 23.78469224-6.56044191 6.59504907-14.50020861 9.88762917-23.79952377 9.88762916-9.31414671 0-17.27368832-3.29258081-23.83413096-9.88762916C144.53861305 596.59608526 141.25097633 588.66620673 141.25097633 579.40149802V444.59355861c0-9.36852878 3.28763673-17.29840732 9.9024607-23.88851303 6.56044191-6.49122901 14.51998353-9.88762917 23.82918686-9.88762918z m0 269.60104654c9.29931517 0 17.23908188 3.29752417 23.79952377 9.88762989 6.63459962 6.59010498 9.90246071 14.51998353 9.90246072 23.8934564v67.34958763c0 9.36852878 3.29258081 17.30335141 9.89751734 23.88851231 6.59010498 6.59010498 14.53481506 9.88762917 23.83413024 9.88762917h67.41385715c9.31414671 0 17.25391343 3.29752417 23.85390586 9.88762989 6.56538599 6.59010498 9.87774172 14.51998353 9.87774243 23.78963633 0 9.36852878-3.31235572 17.19458725-9.87774243 23.8885123-6.59999243 6.49122901-14.53975915 9.88762917-23.85390587 9.88762917H242.42120006c-27.91277775 0-51.72713307-9.88762917-71.49250396-29.66288823-19.75548343-19.77031497-29.63322515-43.55500721-29.63322515-71.46284086V714.19954925c0-9.2696528 3.28269263-17.20447542 9.89751662-23.78963633 6.59010498-6.59010498 14.53481506-9.88762917 23.83413095-9.88762916l-0.03955053-0.09887672z m337.02973524-336.95557825c9.31414671 0 17.23413778 3.29752417 23.8687374 9.88762917 6.55055444 6.59010498 9.86291017 14.51998353 9.86291017 23.78963632v101.12572983h101.13067391c9.29931517 0 17.22919442 3.29752417 23.82918687 9.88762917 6.56538599 6.59010498 9.87279762 14.51998353 9.87279762 23.78963632 0 9.36852878-3.30741236 17.30335141-9.86785427 23.88851304-6.60493653 6.59010498-14.53481506 9.88762917-23.83413022 9.88762916H545.7489508v101.12572983c0 9.2696528-3.31235572 17.20447542-9.86291017 23.78963632-6.63459962 6.59010498-14.55459069 9.88762917-23.8687374 9.88762917-9.29931517 0-17.22919442-3.29752417-23.82424278-9.88762917-6.59010498-6.59010498-9.87774172-14.51998353-9.87774171-23.78963632V545.72423181H377.18958892c-9.30425926 0-17.22425033-3.29752417-23.85390588-9.88762918-6.56538599-6.59010498-9.87774172-14.51998353-9.87774171-23.88851303 0-9.2696528 3.31235572-17.20447542 9.87774171-23.78963632 6.62965553-6.59010498 14.5496466-9.88762917 23.85390588-9.88762917h101.12572982V377.14509429c0-9.2696528 3.28763673-17.20447542 9.8777417-23.78963633 6.59504907-6.59010498 14.52492761-9.88762917 23.82918688-9.88762918z" p-id="2163" fill="#bbbbbb"></path></svg>',
  revertIcon: '<svg t="1751298873093" class="code-tool-line-item-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2380" width="16" height="16"><path d="M377.1862185 478.32251h269.67700171c9.31420898 0 17.23425293 3.29260253 23.84417701 9.88769508 6.57531762 6.59014916 9.87780761 14.52008057 9.87780762 23.78979492 0 9.26971435-3.30249 17.30346656-9.87780762 23.89361572-6.60992408 6.59509253-14.53491211 9.88769508-23.84417701 9.88769507H377.1862185c-9.29937744 0-17.25402856-3.29260253-23.82440209-9.88769507C346.73706078 529.30346656 343.46423316 521.26971435 343.46423316 512s3.27777099-17.20458984 9.89758325-23.79473901c6.57531762-6.59014916 14.52502465-9.88769508 23.82934547-9.88769507m404.49078392-269.64239526H242.36254883c-9.29937744 0-17.21942138 3.29260253-23.82934547 9.88769579-6.58520508 6.48632836-9.88275171 14.52008057-9.8827517 23.78979492v539.29467726c0 9.26971435 3.29754663 17.30346656 9.87780762 23.89361572 6.61486816 6.59014916 14.53491211 9.88769508 23.83428955 9.88769579h539.32434106c9.31420898 0 17.25402856-3.29754663 23.83428955-9.88769579 6.61486816-6.59014916 9.89758325-14.62390137 9.89758253-23.89361572V242.35266137c0-9.26971435-3.28271508-17.30346656-9.89758253-23.78979492-6.58026099-6.59509253-14.52008057-9.88769508-23.82934618-9.88769579M242.33288574 141.21142578h539.33422851c27.89318824 0 51.73736596 9.88769508 71.48309303 29.66308594C872.91076661 190.55102516 882.78857422 214.44464087 882.78857422 242.35266137v539.29467726c0 27.90801978-9.87780761 51.70275879-29.63342286 71.47814965-19.74572778 19.77539086-43.58990479 29.66308594-71.48309301 29.66308594H242.33782983c-27.92285133 0-51.74725342-9.88769508-71.4929812-29.66308594C151.08923339 833.35009742 141.21142578 809.55535913 141.21142578 781.64733863V242.35266137C141.21142578 214.44464087 151.08923339 190.55102516 170.84484863 170.87451172c19.74572778-19.77539086 43.57012915-29.66308594 71.4929812-29.66308594" p-id="2381" fill="#bbbbbb"></path></svg>',
  spawnToolBar(code, otherClass = "") {
    return "<div class='code-tool-line " + otherClass + "'>" +
              "<div class='code-tool-line-item' onclick='copyCode.copyCode(this)' title='复制'>" +
                this.codeCopyIcon +
                "<pre class='code-tool-line-copy-content' hidden>" + code + "</pre>" +
              "</div>" +
              "<div class='code-tool-line-item code-hide' onclick='" + 
                "const parent = this.parentElement.parentElement.parentElement; " + 
                "parent.classList.remove(\"code-pre-show-all\"); " + 
                "window.scrollTo({top: parent.getBoundingClientRect().top + window.scrollY - 65,behavior: \"smooth\"})' title='隐藏代码'>" +
                this.hideIcon +
              "</div>" +
              "<div class='code-tool-line-item code-hide-expand' title='延展' onclick='" + 
                "const parent = this.parentElement.parentElement.parentElement; " + 
                "const flag = parent.classList.contains(\"code-expand\");" + 
                "if (!flag) parent.classList.add(\"code-expand\")" +
              "'>" +
                this.expandIcon +
              "</div>" +
              "<div class='code-tool-line-item code-hide-normal' title='还原' onclick='" + 
                "const parent = this.parentElement.parentElement.parentElement; " + 
                "const flag = parent.classList.contains(\"code-expand\");" + 
                "if (flag) parent.classList.remove(\"code-expand\")" +
              "'>" +
                this.revertIcon +
              "</div>" +
            "</div>";
  },
  init: function (headCount) {
    const render = new marked.Renderer();
    render.heading = function (text, level) {
      if (headCount) {
        headCount(text, level)
      }
      while (text.indexOf('__') !== -1) text = text.replace('__', ' ')
      let id = text;
      while (id.indexOf(" ") !== -1) id = id.replace(" ", "-");
      return "<span id='" + encodeURIComponent(id) + "'></span><h" + level + " id='" + encodeURIComponent(text) + "'>" + text + "</h" + level + ">"
    };

    render.code = (code, infostring, escaped) => {
      const number = code.split("\n").length;
      const needHideCode = number >= 12;
      let oriCode = this.defaultRenderer.code(code, infostring, escaped)
      oriCode = "<div class='ori-code'>" + oriCode.substring(5, oriCode.length - 7) + "</div>"
      // 生成行号
      let lineNumber = "<code class='code-line-number' style='background: none'><span line-row>"
      for (let i = 1; i <= number; ++i) {
        lineNumber += "<span></span>";
      }
      lineNumber += "</span></code>";
      // 将代码与行号及工具栏合并.
      const codePre = "<pre>" + this.spawnToolBar(code, "") + lineNumber + oriCode + this.spawnToolBar(code, "code-tool-line-foot code-hide") + "</pre>";
      const showAllButton = "<button class='code-pre-show-all-btn' onclick='this.parentElement.classList.add(\"code-pre-show-all\")'>显示更多</button>"
      return "<div class='code-pre'>" + codePre + (needHideCode ? showAllButton : "") + "</div>\n"
    }
    marked.setOptions({
      renderer: render,
      gfm: true,
      tables: true,
      breaks: false,
      pedantic: false,
      sanitize: false,
      smartLists: true,
      smartypants: true,
      highlight: function (code, lang) {
        const language = hljs.getLanguage(lang) ? lang : "";
        if (language === "") {
          return hljs.highlightAuto(code).value;
        } else {
          return hljs.highlight(code, { language }).value;
        }
      }
    });
  },
  render: function (text) {
    return (
      <MathJax.Provider input="tex" options={{
        tex: {inlineMath: [['$', '$'], ['\\(', '\\)']]},
        skipHtmlTags: [
          'script', 'noscript', 'style', 'textarea', 'pre',
          'code', 'annotation', 'annotation-xml'
        ],
      }} url="https://unpkg.zhimg.com/mathjax@3.2.0/es5/tex-mml-chtml.js">
        <div className="entry-content">
          <MathJax.Html html={ marked(text) } />
        </div>
      </MathJax.Provider>
    );
  },
  renderWithoutMath: function (text) {
    return marked(text)
  }
}
